<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CCNS 嘴砲聊天室</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="//cdn.rawgit.com/TeaMeow/TocasUI/master/dist/tocas.min.css">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
  <script src="cmd.js"></script>
</head>
<body>
  <ul class="ts list" id="messages"></ul>
  <div id="form">
    <div class="ts input" id="name">
      <input id="n" autocomplete="off" placeholder="暱稱(10字內英數)" maxlength="10" onkeyup="value=value.replace(/[^\w&@]|_/ig,'')" onblur="value=value.replace(/[^\w&@]|_/ig,'')" />
    </div>
    <div class="ts fluid input" id="input">
      <input id="m" autocomplete="off" placeholder="請輸入留言"/>
    </div>
    <div id="btnContainer">
      <button class="ts button" id="send">Send</button>
    </div>
  </div>

  <script>
    var wh = $(window).height();
    var ww = $(window).width();
    var fh = $('#form').height();
    $('#messages').height(wh-fh);

    var socket = io();
    $('#send').click(function(){
      var msg = $('#m').val();
      var name = $('#n').val();
      if (msg != '') {
        socket.emit('chat message', {name: name, msg: msg});
        $('#m').val('');
      }
      return false;
    });
    $('#input').keydown(function (e){
      if(e.keyCode == 13){
        $('#send').click();
      }
    })
    socket.on('chat message', function(msg){
      var li = $('<li>');
      if (msg.name == '@@@') {
        li.append($('<div>').addClass('name').append($('<b>').text('[系統訊息]')));
      } else {
        li.append($('<div>').addClass('name').text(msg.name + ' 說'));
      }

      var html = toHtmlText(msg.msg);
      li.append($('<div>').addClass('msg').html(html));
      $('#messages').append(li);
      $('#messages').animate({scrollTop: $('#messages').prop("scrollHeight")}, 300);
      shoot(html);
    });

    var n = 0;
    function shoot(html){
      var id = 'b' + n;
      var w = ww + 50;
      var h = (wh - 50 - 100) * Math.random() + 50;
      var m = $('<span>').addClass('bullet')
                      .attr('id', id)
                      .html(html)
                      .css({left: w, top: h});
      $('body').append(m);
      setTimeout(function(){
        var nm = $('#'+id);
        var mw = nm.width() + 100;
        nm.animate({left: -mw}, 10000, function(){
          $('#'+id).remove();
        });
      }, 500);
      n++;
    }
  </script>
</body>
</html>
